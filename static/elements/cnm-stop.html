<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/core-icon-button/core-icon-button.html">

<link rel="import" href="/elements/favorite-service.html">

<polymer-element name="cnm-stop" attributes="stop favorites hiddenLines">
  <template>
    <link rel="stylesheet" href="/css/colors.css">
    <style>
    :host {
      display: block;
      width: 100%;
    }

    .line {
      padding-left: 8px;
      padding-right: 8px;
      padding-top: 6px;
      padding-bottom: 6px;
      font-size: 14px;
      color: white;
    }

    .line-Y {
      color: black;
    }

    .arrival hr {
      margin-top: 4px;
      margin-bottom: 4px;
      width: 80%;
    }

    .arrivals {
      padding-top: 5px;
      padding-bottom: 5px;
    }

    </style>

    <favorite-service id="favorite_service"
      on-favorite-toggled="{{favoriteToggled}}">
    </favorite-service>

    <template if="{{showFavorite && showHiddenLines}}">
      <div class="line line-{{stop.LineKey}}" layout horizontal center>
        <div>{{stop.Name}}</div>
        <div flex></div>
        <div>
          <core-icon-button
            icon="{{favoriteIcon}}"
            on-tap="{{favoriteTapped}}">
          </core-icon-button>
        </div>
      </div>
      <div layout horizontal class="arrivals">
        <template repeat="{{arrival in arrivals}}">
          <div flex class="arrival">
            <template if="{{arrival != null}}">
              <div layout vertical center>
                <template if="{{!arrival.IsApproaching}}">
                  {{arrival.ArrivingInMinutes}}
                  {{"min" | pluralize(arrival.ArrivingInMinutes)}}
                </template>
                <template if="{{arrival.IsApproaching}}">
                  Approaching
                </template>
                <hr class="line-{{stop.LineKey}}">
                {{arrival.ArrivingAt | shortTime}}
                <template if="{{arrival.IsDelayed}}">
                  *
                </template>
              </div>
            </template>
          </div>
        </template>
      </div>
    </template>
  </template>
  <script>
  Polymer("cnm-stop", {
    favorites: false,
    favoriteKick: 0,
    ready: function() {
      this.favoriteKick++;
    },
    computed: {
      arrivals: "sliced(stop.Arrivals)",
      favoriteIcon: "chooseFavoriteIcon(stop, favoriteKick)",
      showFavorite: "computeShowFavorite(stop, favorites, favoriteKick)",
      showHiddenLines: "computeShowHiddenLines(stop, hiddenLines)"
    },
    sliced: function(value) {
      if (value) {
        var arr = value.slice(0);           // copy array
        arr.splice(3, 0, null, null, null); // make sure it's at least 3 long
        return arr.splice(0, 3);            // only return the first three
      }
    },
    pluralize: function(base, value) {
      if (value != 1) {
        return base + "s";
      } else {
        return base;
      }
    },
    shortTime: function(value) {
      if (value) {
        var d = new Date(value);
        var hours = d.getHours();
        var ampm = "PM";
        if (hours < 12) {
          ampm = "AM";
        }
        if (hours == 0) {
          hours += 12;
        } else if (hours > 12) {
          hours -= 12;
        }
        var minutes = d.getMinutes();
        if (minutes < 10) {
          minutes = "0" + minutes;
        }
        return hours + ":" + minutes + " " + ampm;
      }
    },
    chooseFavoriteIcon: function(stop) {
      if (this.$ && stop) {
        if (this.$.favorite_service.isFavorite(stop)) {
          return "favorite";
        } else {
          return "favorite-outline";
        }
      } else {
        return "favorite-outline";
      }
    },
    computeShowFavorite: function(stop, favorites, serv) {
      if (!favorites) {
        return true;
      } else if (this.$ && stop) {
        if (!this.$.favorite_service.isFavorite(stop)) {
          return false;
        } else {
          return true;
        }
      } else {
        return true;
      }
    },
    computeShowHiddenLines: function(stop, hiddenLines) {
      if (stop && hiddenLines) {
        var lines = hiddenLines.split(",");
        return lines.indexOf(stop.LineKey) == -1;
      } else {
        return true;
      }
    },
    favoriteTapped: function(e) {
      this.$.favorite_service.toggleFavorite(this.stop);
    },
    favoriteToggled: function(e) {
      console.log("favorite-toggled", e.detail);
      this.favoriteKick++;
    }
  });
  </script>
</polymer-element>
